#!/bin/bash

# Treat unset variables as an error
set -u

# See comments in install script
app=$YNH_APP_INSTANCE_NAME

# Source YunoHost helpers
source /usr/share/yunohost/helpers

# Source local helpers
source ./_common.sh

# Retrieve app settings
domain=$(ynh_app_setting_get "$app" domain)

# Prepare to execute uninstaller(generated by NetData install script)
UNINSTALL_SCRIPT="netdata-uninstaller.sh"

# Move outside the directory (which will be removed)
sudo mv /opt/netdata/etc/netdata/${UNINSTALL_SCRIPT} /tmp
cd /tmp

# Remove the need for interaction
sudo sed -i "s/rm -i/rm -f/g" ${UNINSTALL_SCRIPT}
sudo sed -i "s/rm -I/rm -f/g" ${UNINSTALL_SCRIPT}
# Execute the uninstall script
sudo ./${UNINSTALL_SCRIPT} --force

# Remove app dependencies
ynh_package_autoremove "$DEPS_PKG_NAME" || true

# Remove user and group
sudo userdel netdata

# Remove nginx configuration file
sudo rm -f /etc/nginx/conf.d/$domain.d/$app.conf
sudo rm -rf /home/yunohost.app/$app

# Reload nginx service
sudo service nginx reload


